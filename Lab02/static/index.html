<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Sklep internetowy</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .page {
            width: 100%;
            max-width: 1200px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 24px 32px 32px;
        }

        h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 24px;
            color: #059669;
            letter-spacing: 0.03em;
        }

        h2 {
            margin: 0 0 12px;
            font-size: 1.1rem;
            color: #111827;
        }

        .grid-two {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px 18px 18px;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 8px;
            margin-top: 8px;
        }

        .form-row label {
            font-size: 0.8rem;
            color: #6b7280;
            display: block;
            margin-bottom: 2px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px rgba(59,130,246,0.4);
        }

        .btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        thead {
            background: #e5e7eb;
        }

        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        th {
            font-weight: 600;
            color: #4b5563;
        }

        tr:nth-child(even) td {
            background: #f9fafb;
        }

        .cart-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .cart-total-row span {
            font-weight: 600;
        }

        .cart-total-amount {
            font-size: 1rem;
            color: #111827;
        }

        .error {
            color: #b91c1c;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .status-msg {
            font-size: 0.85rem;
            margin-top: 6px;
        }

        .status-msg.error {
            color: #b91c1c;
        }

        .status-msg.success {
            color: #15803d;
        }

        @media (max-width: 900px) {
            .grid-two {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <h1>Sklep internetowy</h1>

    <div class="grid-two">
        <div>
            <div class="card">
                <div class="card-header">
                    <h2>Dodaj produkt</h2>
                    <span style="font-size:0.8rem;color:#6b7280">(do testów)</span>
                </div>

                <div class="form-row">
                    <div>
                        <label for="new-name">Nazwa</label>
                        <input id="new-name" type="text" placeholder="Np. Jabłko">
                    </div>
                    <div>
                        <label for="new-price">Cena</label>
                        <input id="new-price" type="number" step="0.01" min="0" placeholder="Np. 2.50">
                    </div>
                    <div style="display:flex;align-items:flex-end;">
                        <button id="add-product-btn" class="btn btn-primary" style="width:100%;">Dodaj produkt</button>
                    </div>
                </div>

                <div id="products-error" class="error"></div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-header">
                    <h2>Lista produktów</h2>
                </div>

                <table id="products-table">
                    <thead>
                    <tr>
                        <th style="width:40px;">ID</th>
                        <th>Nazwa</th>
                        <th style="width:80px;">Cena</th>
                        <th style="width:80px;">Ilość</th>
                        <th style="width:90px;text-align:center;">Akcja</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div>
            <div class="card">
                <div class="card-header">
                    <h2>Koszyk</h2>
                </div>

                <div id="cart-msg" class="status-msg"></div>

                <table id="cart-table">
                    <thead>
                    <tr>
                        <th>Nazwa</th>
                        <th style="width:80px;">Cena szt.</th>
                        <th style="width:80px;">Ilość</th>
                        <th style="width:80px;">Suma</th>
                        <th style="width:120px;">Akcje</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- kupon -->
                <div style="display:flex; gap:8px; margin-top:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label for="coupon-code" style="font-size:0.8rem;color:#6b7280;">Kod rabatowy</label>
                        <input id="coupon-code" type="text" placeholder="Np. PROMO10">
                    </div>
                    <button id="apply-coupon-btn" class="btn btn-primary">Zastosuj kupon</button>
                </div>
                <div id="coupon-info" class="status-msg"></div>

                <div class="cart-total-row">
                    <div>
                        Razem:
                        <span id="cart-total" class="cart-total-amount">0.00</span> zł
                    </div>
                    <button id="checkout-btn" class="btn btn-success">Zamów</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function fetchJSON(url, options = {}) {
        const res = await fetch(url, {
            headers: { "Content-Type": "application/json" },
            ...options
        });

        const data = await res.json().catch(() => null);

        if (!res.ok) {
            throw new Error(data?.error || ("Błąd " + res.status));
        }

        return data;
    }

    async function loadProducts() {
        const tbody = document.querySelector("#products-table tbody");
        const errDiv = document.getElementById("products-error");

        tbody.innerHTML = "";
        errDiv.textContent = "";

        try {
            const products = await fetchJSON("/api/products");

            products.forEach(p => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.price.toFixed(2)}</td>
                    <td><input type="number" min="1" value="1" style="width:60px;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db"></td>
                    <td style="text-align:center;">
                        <button class="btn btn-success btn-sm">Dodaj</button>
                    </td>
                `;

                const qtyInput = tr.querySelector("input");
                const btn = tr.querySelector("button");

                btn.addEventListener("click", async () => {
                    try {
                        const qty = parseInt(qtyInput.value || "1", 10);
                        await fetchJSON("/api/cart/add", {
                            method: "POST",
                            body: JSON.stringify({
                                product_id: p.id,
                                qty: qty
                            })
                        });
                        await loadCart();
                    } catch (e) {
                        alert(e.message);
                    }
                });

                tbody.appendChild(tr);
            });

        } catch (e) {
            errDiv.textContent = e.message;
        }
    }

    async function loadCart() {
        const tbody = document.querySelector("#cart-table tbody");
        const totalSpan = document.getElementById("cart-total");
        const msgDiv = document.getElementById("cart-msg");
        const couponInfo = document.getElementById("coupon-info");

        tbody.innerHTML = "";
        msgDiv.textContent = "";
        msgDiv.className = "status-msg";
        couponInfo.textContent = "";
        couponInfo.className = "status-msg";

        try {
            const cart = await fetchJSON("/api/cart");

            cart.items.forEach(item => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.unit_price.toFixed(2)}</td>
                    <td><input type="number" min="1" value="${item.qty}" style="width:60px;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db"></td>
                    <td>${item.line_total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm update-btn">Zmień</button>
                        <button class="btn btn-danger btn-sm delete-btn">Usuń</button>
                    </td>
                `;

                const qtyInput = tr.querySelector("input");
                const updateBtn = tr.querySelector(".update-btn");
                const deleteBtn = tr.querySelector(".delete-btn");

                updateBtn.addEventListener("click", async () => {
                    try {
                        const qty = parseInt(qtyInput.value || "1", 10);
                        await fetchJSON("/api/cart/item", {
                            method: "PATCH",
                            body: JSON.stringify({
                                product_id: item.product_id,
                                qty: qty
                            })
                        });
                        await loadCart();
                    } catch (e) {
                        alert(e.message);
                    }
                });

                deleteBtn.addEventListener("click", async () => {
                    try {
                        await fetchJSON(`/api/cart/item/${item.product_id}`, {
                            method: "DELETE"
                        });
                        await loadCart();
                    } catch (e) {
                        alert(e.message);
                    }
                });

                tbody.appendChild(tr);
            });

            // jeśli jest kupon – użyj total_with_discount
            const total = (cart.total_with_discount ?? cart.total ?? 0);
            totalSpan.textContent = total.toFixed(2);

            if (cart.coupon) {
                couponInfo.textContent = `Zastosowano kupon ${cart.coupon.code} (-${cart.coupon.percent}%)`;
                couponInfo.className = "status-msg success";
            }

        } catch (e) {
            msgDiv.textContent = e.message;
            msgDiv.className = "status-msg error";
        }
    }

    document.getElementById("add-product-btn").addEventListener("click", async () => {
        const nameInput = document.getElementById("new-name");
        const priceInput = document.getElementById("new-price");

        try {
            await fetchJSON("/api/products", {
                method: "POST",
                body: JSON.stringify({
                    name: nameInput.value,
                    price: priceInput.value
                })
            });

            nameInput.value = "";
            priceInput.value = "";
            await loadProducts();

        } catch (e) {
            alert(e.message);
        }
    });

    document.getElementById("apply-coupon-btn").addEventListener("click", async () => {
        const codeInput = document.getElementById("coupon-code");
        const couponInfo = document.getElementById("coupon-info");

        couponInfo.textContent = "";
        couponInfo.className = "status-msg";

        try {
            const data = await fetchJSON("/api/cart/apply-coupon", {
                method: "POST",
                body: JSON.stringify({ code: codeInput.value })
            });

            couponInfo.textContent = `Zastosowano kupon ${data.coupon.code} (-${data.coupon.percent}%)`;
            couponInfo.className = "status-msg success";

            await loadCart();
        } catch (e) {
            couponInfo.textContent = e.message;
            couponInfo.className = "status-msg error";
        }
    });

    document.getElementById("checkout-btn").addEventListener("click", async () => {
        const msgDiv = document.getElementById("cart-msg");

        msgDiv.textContent = "";
        msgDiv.className = "status-msg";

        try {
            const data = await fetchJSON("/api/checkout", { method: "POST" });

            msgDiv.textContent = `Zamówienie #${data.order_id} przyjęte, suma do zapłaty: ${data.total.toFixed(2)} zł`;
            msgDiv.className = "status-msg success";

            await loadCart();

        } catch (e) {
            msgDiv.textContent = e.message;
            msgDiv.className = "status-msg error";
        }
    });

    // start
    loadProducts();
    loadCart();
</script>
</body>
</html>
