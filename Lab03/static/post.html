<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Post – szczegóły</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <h1>Szczegóły posta</h1>

  <div class="section" id="post"></div>

  <div class="section">
    <div class="section-title">Komentarze (zatwierdzone)</div>
    <div id="comments"></div>
  </div>

  <div class="section">
    <div class="section-title">Dodaj komentarz (trafia do moderacji)</div>
    <input id="author" type="text" placeholder="Autor (opcjonalnie)">
    <textarea id="body" rows="3" placeholder="Treść komentarza"></textarea>
    <button id="add-comment">Wyślij komentarz</button>
    <div id="comment-msg" class="small"></div>
  </div>

  <a class="link" href="/">← Wróć do listy postów</a>
</div>

<script>
const postId = window.location.pathname.split("/").pop();

async function loadPost() {
  const res = await fetch('/api/posts');
  const posts = await res.json();
  const post = posts.find(p => p.id == postId);
  const div = document.getElementById('post');
  if (!post) {
    div.innerHTML = 'Nie znaleziono posta.';
    return;
  }
  const dateObj = new Date(post.created_at);
const formattedDate = isNaN(dateObj)
  ? post.created_at
  : dateObj.toLocaleString('pl-PL', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

div.innerHTML = `
  <strong>${post.title}</strong><br>
  <span class="small">${formattedDate}</span>
  <p>${post.body}</p>
`;

}

async function loadComments() {
  const res = await fetch(`/api/posts/${postId}/comments`);
  const comments = await res.json();
  const container = document.getElementById('comments');
  container.innerHTML = '';
  if (comments.length === 0) {
    container.innerHTML = '<span class="small">Brak zatwierdzonych komentarzy.</span>';
    return;
  }
  comments.forEach(c => {
  const div = document.createElement('div');
  div.className = 'comment-card';

  const dateObj = new Date(c.created_at);
  const formattedDate = isNaN(dateObj)
    ? c.created_at
    : dateObj.toLocaleString('pl-PL', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

  div.innerHTML = `
    <strong>${c.author}</strong>
    <span class="small"> (${formattedDate})</span>
    <p>${c.body}</p>
  `;
  container.appendChild(div);
});

}

document.getElementById('add-comment').addEventListener('click', async () => {
  const author = document.getElementById('author').value;
  const body = document.getElementById('body').value;
  const msg = document.getElementById('comment-msg');
  msg.textContent = '';

  const res = await fetch(`/api/posts/${postId}/comments`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({author, body})
  });

  if (res.status === 201) {
    document.getElementById('body').value = '';
    msg.textContent = 'Komentarz wysłany do moderacji.';
  } else {
    const data = await res.json();
    msg.textContent = 'Błąd: ' + (data.error || res.status);
  }
});

loadPost();
loadComments();
</script>
</body>
</html>
